<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="../script/map/jquery.js" type="text/javascript"></script>
    <script src="../script/map/bootstrap.js" type="text/javascript"></script>
    <script src="../script/map/FileSaver.min.js" type="text/javascript"></script>
    <script src="../script/map_custom/captureMapElement.js" type="text/javascript"></script>
    <script src="../script/map/toBitmapURL.js" type="text/javascript"></script>
    <link href="../App_Themes/Map/css/reset.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/bootstrap.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/layout.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/map.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/nanoscroller.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/table.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
         var mapPlugin = null;
        var resizeInterval = null;
        var printImgURL = null;
        var printTitle = null;
        var imageTitle = null;
        var scaleMM = 30; // mm
        var scalePixel = null; // scaleMM 轉成 pixel後的數值
        var scaleReal = null; // scale表示的實際長度
        var scaleLength = null; // scale畫上去的pixel數
        $(function () {
            mapPlugin = parent.mapPlugin;
            resizeLayout();
        });
        function resizeLayout() {
            clearInterval(resizeInterval);
            resizeInterval = setInterval(function () {
                parent.resizeBox($(".nano").offset().top + $("#content").height() + 15);
                if ($(".nano").height() != ($("html").height() - $(".nano").offset().top)) {
                    $(".nano").height($("html").height() - $(".nano").offset().top);
                }
                clearInterval(resizeInterval);
            }, 200);
        }
        $(window).on("resize", function () {
            resizeLayout();
        });

        function switchLayerTab(layerName) {
            $("input.BtnTab").removeClass("TabActive");
            $("input.BtnTab[value='" + layerName + "']").addClass("TabActive");
            $("div[containName]").hide();
            $("div[containName='" + layerName + "']").show();
            resizeLayout();
            if (layerName == '儲存圖片') {
                showCaptureExtent();
            } else {
                showPrintExtent();
            }
        }

        function showPrintExtent() {
            var $divExtent = parent.$("#tableCaptureExtent div");
            var mmSize = [];
            if ($("input[name='paperDirection']:checked").val() == 'vertical') {
                mmSize = [210 - 38, 297 - 38];
            } else {
                mmSize = [297 - 38, 210 - 38];
            }
            $divExtent.width(mmSize[0] + "mm").height(mmSize[1] + "mm");
            parent.$("#tableCaptureExtent").show();
            if (!scalePixel && mmSize[0] != 0) {
                scalePixel = Math.round($divExtent.width() / mmSize[0] * scaleMM);
            }
            var mapSize = mapPlugin.getMap().getSize();
            var capSize = [$divExtent.outerWidth(), $divExtent.outerHeight()];
            if (capSize[0] > mapSize[0]) capSize[0] = mapSize[0];
            if (capSize[1] > mapSize[1]) capSize[1] = mapSize[1];
            $divExtent.outerWidth(capSize[0]);
            $divExtent.outerHeight(capSize[1]);
        }

        function printIt() {
            createRotatedImage(parent.document.getElementById("exportNortharrow"));
            var srcElement = event.srcElement;
            disableButton(srcElement, "產製列印畫面中....");
            var extentDom = parent.$("#tableCaptureExtent div");
            var capSize = [extentDom.width(), extentDom.height()];
            if (scalePixel) {
                scaleReal = mapPlugin.getMap().getView().getResolution() * scalePixel;
                var unit = "公尺";
                if (scaleReal > 1000) {
                    scaleReal /= 1000;
                    unit = "公里";
                }
                var ori = scaleReal;
                var digit = 0;
                while (scaleReal > 10) {
                    digit++;
                    scaleReal /= 10;
                }
                scaleReal = Math.round(scaleReal);
                for (var i = 0; i < digit; i++) {
                    scaleReal *= 10;
                }
                scaleLength = Math.round(scalePixel * scaleReal / ori);
                scaleReal = scaleReal + unit;
            }
            var canvases = $(parent.map.getViewport()).find("canvas")[0];
            canvas = document.createElement('canvas');
            canvas.setAttribute('width', capSize[0]);
            canvas.setAttribute('height', capSize[1]);
            canvas.setAttribute('id', 'printCanvas');
            canvases.appendChild(canvas);

            var ctx = canvas.getContext("2d");
            var mapSize = mapPlugin.getMap().getSize();
            var startPixel = [(mapSize[0] - capSize[0]) / 2, (mapSize[1] - capSize[1]) / 2];
            ctx.drawImage(canvases, -startPixel[0], -startPixel[1]);
            var format = $("#ddlImageFormat").val();
            result = canvas.toDataURL();
            showPrintLayout(result);
            enableButton(srcElement, "列印");
            /*mapPlugin.captureMapCenter(capSize, "png", function (r) {
                if (r.imageURL || r.imageURL == "") {
                    showPrintLayout(r.imageURL);
                } else {
                    alert("截圖失敗");
                }
                enableButton(srcElement, "列印");
            });*/
        }

        function showPrintLayout(src) {
            printImgURL = src;
            printTitle = $("#txtPrintTitle").val();
            setTimeout(function () {
                var printDoc = window.open('printLayout.htm', '_blank');
            },1);
            //printDoc.location = "printLayout.htm";
        }

        function saveIt() {
            var srcElement = event.srcElement;
            disableButton(srcElement, "圖片產製中...");
            var extentDom = parent.$("#tableCaptureExtent div");
            var capSize = [extentDom.width(), extentDom.height()];
            if (!capSize) alert('您輸入的長寬不正確');
            var canvases = $(parent.map.getViewport()).find("canvas")[0];
            canvas = document.createElement('canvas');
            canvas.setAttribute('width', capSize[0]);
            canvas.setAttribute('height', capSize[1]);          
            canvas.setAttribute('id', 'photoCanvas');         
            canvases.appendChild(canvas);

            var ctx = canvas.getContext("2d");
            var mapSize = mapPlugin.getMap().getSize();
            var format = $("#ddlImageFormat").val();
            var startPixel = [(mapSize[0] - capSize[0]) / 2, (mapSize[1] - capSize[1]) / 2];
            ctx.drawImage(canvases, -startPixel[0], -startPixel[1]);
            result = canvas.toDataURL();
            canvas.toBlob(function (result) {
                saveAs(result, 'map.' + format);
            });
            enableButton(srcElement, "儲存");            
            /*mapPlugin.captureMapCenter(capSize, $("#ddlImageFormat").val(), function (r) {
                if (r.imageURL || r.imageURL == "") {
                    window.open("service/GetMapCaptureImg.ashx?imgUrl=" + encodeURIComponent(r.imageURL));
                } else {
                    alert("截圖失敗");
                }
                enableButton(srcElement, "儲存");
            });*/
            
        }
        
        function disableButton(but, newText) {
            var $it = but;
            if (!$.prototype.isPrototypeOf($it)) {
                $it = $(but);
            }
            $it.prop("disabled", true);
            $it.css("color", "gray");
            $it.attr("value", newText);
        }

        function enableButton(but, newText) {
            var $it = but;
            if (!$.prototype.isPrototypeOf($it)) {
                $it = $(but);
            }
            $it.prop("disabled", false);
            $it.css("color", "");
            $it.attr("value", newText);
        }

        function showCaptureExtent() {
            var capSize = getImageSize();
            if (!capSize) return;
            parent.$("#tableCaptureExtent div").width(capSize[0]).height(capSize[1]);
            parent.$("#tableCaptureExtent").show();
        }

        function getImageSize() {
            var $checked = $("input[name='capSize']:checked");
            if ($checked.length == 0) return;
            var capSize = $checked.val();
            var capWidth, capHeight;
            if (capSize == "custom") {
                try {
                    capWidth = parseInt($("#txtCaptureWidth").val(), 10);
                    capHeight = parseInt($("#txtCaptureHeight").val(), 10);
                } catch (e) {
                    return null;
                }
            } else {
                capSize = capSize.split(",")
                capWidth = parseInt(capSize[0], 10);
                capHeight = parseInt(capSize[1], 10);
            }
            return [capWidth, capHeight];
        }

        function hideCaptureExtent() {
            parent.$("#tableCaptureExtent").hide();
        }
    </script>
    <!-- page event -->
    <script type="text/javascript">
        function page_active() {
            parent.useMisFunctonFrame.CloseFullDownFrame();
            if ($(".TabBox > .TabActive").val() == '列印圖片') {
                showPrintExtent();
            } else {
                showCaptureExtent();
            }
        }
        function page_leave() {
            parent.$("#tableCaptureExtent").hide();
        }
        var helpHtml = "<p>• 請平移地圖，將要匯出的範圍移動至範圍內</p>";
    </script>
    <!-- create legend -->
</head>
<body>
    <div class="BtnFunc">
        <ul>
            <li class="close"><a href="javascript:void(0);parent.toolSwitch()">關閉</a></li>
            <li class="help"><a href="javascript:void(0);" onclick="parent.showHelp(helpHtml);">說明</a></li>
        </ul>
    </div>
    <!--關閉+說明-->
    <!--頁籤-->
    <div class="TabBox">
        <input type="button" name="button" class="BtnTab TabActive" value="列印圖片" onclick="switchLayerTab('列印圖片')" />
        <input type="button" name="button" class="BtnTab" value="儲存圖片" onclick="switchLayerTab('儲存圖片')" />
    </div>
    <!--頁籤結尾-->
    <!--可捲動範圍-->
    <div class="nano">
        <div class="nano-content">
            <div id="content">
                <div containname="列印圖片">
                    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="ListGrey">
                        <tr>
                            <th width="80px">
                                圖名
                            </th>
                            <td >
                                <input type="text" id="txtPrintTitle" />
                            </td>
                        </tr>
                        <tr>
                            <th width="80px">
                                紙張方向
                            </th>
                            <td>
                                <input type="radio" name="paperDirection" value="vertical" checked="checked" onclick="showPrintExtent()" />
                                直向
                                <input type="radio" name="paperDirection" value="horizontal" onclick="showPrintExtent()" />
                                橫向
                            </td>
                        </tr>
                    </table>
                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td align="center">
                                <input type="button" name="button2" id="button2" class="BtnWhite" value="列印" onclick="printIt();" />
                            </td>
                        </tr>
                    </table>
                </div>
                <div containname="儲存圖片" style="display: none">
                    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="ListGrey">
						<tr>
                            <td width="24%">
                                圖名
                            </td>
                            <td width="76%">
                                <input type="text" id="txtImageTitle" />
                            </td>
                        </tr>
                        <tr>
                            <td width="24%" rowspan="2">
                                圖片尺寸
                            </td>
                            <td width="76%">
                                <input type="radio" name="capSize" value="640,480" checked="checked" onclick="showCaptureExtent();" />
                                640x480
                                <input type="radio" name="capSize" value="800,600" onclick="showCaptureExtent();" />
                                800x600
                                <input type="radio" name="capSize" value="1024,768" onclick="showCaptureExtent();" />
                                1024x768
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input type="radio" name="capSize" value="custom" onclick="showCaptureExtent();" />
                                自訂尺寸
                                <input type="text" id="txtCaptureWidth" size="5" onkeyup="showCaptureExtent();" />
                                x
                                <input type="text" id="txtCaptureHeight" size="5" onkeyup="showCaptureExtent();" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                圖片格式
                            </td>
                            <td>
                                <select id="ddlImageFormat">
                                    <option value="png">png</option>
                                    <option value="jpg">jpeg</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td align="center">
                                <input type="submit" class="BtnWhite" value="下一步" onclick="captureMapElement();" />
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--可捲動範圍結尾-->   
</body>
</html>
